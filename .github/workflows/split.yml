name: Split packages
on:
  push:
    tags: ['v*']

permissions:
  contents: write

#env:
#  GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

jobs:
  split:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - local: packages/addons
            repo:  cognesy/instructor-addons
            name:  instructor-addons

          - local: packages/auxiliary
            repo:  cognesy/instructor-aux
            name:  instructor-aux

          - local: packages/http-client
            repo:  cognesy/instructor-http-client
            name:  instructor-http-client

          - local: packages/hub
            repo:  cognesy/instructor-hub
            name:  instructor-hub

          - local: packages/instructor
            repo:  cognesy/instructor-struct
            name:  instructor-struct

          - local: packages/polyglot
            repo:  cognesy/instructor-polyglot
            name:  instructor-polyglot

          - local: packages/setup
            repo:  cognesy/instructor-setup
            name:  instructor-setup

          - local: packages/tell
            repo:  cognesy/instructor-tell
            name:  instructor-tell

          - local: packages/utils
            repo:  cognesy/instructor-utils
            name:  instructor-utils

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper splitting

      # Verify release notes exist for this package
      - name: Verify release notes
        run: |
          TAG=${{ github.ref_name }}                            # v0.13.2
          NOTES={{ matrix.local }}/release_notes/${TAG}.md
          if [[ -f "$NOTES" ]]; then
            echo "release notes found: $NOTES"
          else
            echo "no notes – creating stub → $NOTES"
            mkdir -p "$(dirname "$NOTES")"
            printf '# %s\n\nSplit release of %s.\n' "$TAG" "${{ matrix.name }}" > "$NOTES"
          fi

      # ► push branch + tag
      - name: Split Monorepo
        uses: "danharrin/monorepo-split-github-action@v2.3.0"
        with:
          github_token: ${{ secrets.SPLIT_TOKEN }}      # PAT here
          tag: ${{ github.ref_name }}             # e.g. v1.2.3
          package_directory: ${{ matrix.package.local }}
          repository_organization: cognesy
          repository_name: ${{ matrix.package.name }}
          user_name: 'ci‑bot'
          user_email: 'ci@cognesy.com'

      # ► create GitHub Release with notes
      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        env:
          GITHUB_TOKEN: ${{ secrets.SPLIT_TOKEN }}     # PAT once for all API calls
        with:
          repository: ${{ matrix.package.repo }}          # target repo
          tag_name:    ${{ github.ref_name }}             # v1.2.3
          body_path:   ${{ matrix.package.local }}/release_notes/${{ github.ref_name }}.md
