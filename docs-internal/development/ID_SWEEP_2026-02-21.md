# ID Sweep Report (2026-02-21)

## Scope

- Sweep command: `rg -n --pcre2 '\\b\\??string\\s+\\$[A-Za-z_][A-Za-z0-9_]*Id\\b' packages/*/src -g'*.php'`
- Total matches: `180`
- Package distribution:
  - `agents`: 59
  - `agent-ctrl`: 35
  - `experimental`: 31
  - `auxiliary`: 27
  - `polyglot`: 17
  - `doctor`: 4
  - `hub`: 3
  - `messages`: 2
  - `logging`: 1
  - `laravel`: 1

## Classification Summary

## Owned IDs (migrate to typed domain IDs)

1. `packages/agents/src/Capability/ExecutionHistory/ExecutionStore.php`
- Current: `record/all/last/count` accept `string $agentId`; `ExecutionSummary` stores `string $executionId`.
- Recommendation: migrate to `AgentId` and `ExecutionId` in store contract + summary model; keep string only at persistence/event boundaries.
- Priority: High.

2. `packages/agents/src/Session/AgentSessionInfo.php`
- Current: `parentId` is `?string`.
- Recommendation: migrate to `?SessionId` in aggregate internals; serialize parent as string.
- Priority: High.

## External IDs (opaque wrappers, no UUID generation)

1. `packages/agent-ctrl/src/Dto/AgentResponse.php`
- Current: `?string $sessionId`.
- Recommendation: internal wrapper by provider boundary (`OpenCodeSessionId` / `CodexThreadId` mapping) and keep string getter for transport/API.
- Priority: Medium.

2. `packages/agent-ctrl/src/Dto/ToolCall.php`, `packages/agent-ctrl/src/Event/AgentToolUsed.php`
- Current: `?string $callId`.
- Recommendation: use provider-agnostic opaque `AgentToolCallId` internally; string at event payload/output boundary.
- Priority: Medium.

3. `packages/messages/src/Utils/File.php`
- Current: `string $fileId`.
- Recommendation: use opaque external `FileId` value object only if file IDs are used as identity in domain logic (currently mostly passthrough).
- Priority: Low.

## Keep String (reference keys / boundary-only values)

1. CLI request builders and bridge request DTOs
- Examples: `resumeSessionId`, `sessionId` in `agent-ctrl` builders/requests.
- Rationale: transport boundary values sent to external CLIs; mapping to typed IDs already occurs in parser/response domain side.

2. Event payload IDs in `agents` and `polyglot`
- Examples: `agentId`, `executionId`, `attemptId` fields in event DTOs.
- Rationale: event bus payload boundary; keep as strings for serialization stability.

3. `auxiliary`/`doctor`/`hub` task, codeblock, source IDs
- Rationale: these are external/reference keys (bd issue IDs, markdown block IDs, config source keys), not aggregate identities owned by this domain.

4. `experimental` signature/model IDs
- Rationale: mostly model/config reference keys and optimization labels; defer typed wrappers unless behavior/invariants emerge.

## High-Impact Follow-up Tasks Created

1. `instructor-php-4ag`
- Migrate Agents ExecutionHistory IDs (`agentId`, `executionId`) to typed domain IDs.

2. `instructor-php-uf0`
- Migrate Agents Session `parentId` from string to `SessionId` in aggregate internals.

3. `instructor-php-tgv`
- Unify agent-ctrl aggregated response/tool-call IDs with thin opaque external wrappers.

## Residual Risk

- Medium risk in `agents` if execution history store typing is postponed: ongoing string normalization and weaker contracts.
- Low risk in `agent-ctrl` aggregated DTOs: mostly boundary layer today, but domain-policy logic may start depending on raw strings.
- Low risk for keep-string areas (`auxiliary`, `doctor`, `experimental`) where IDs are labels/transport refs rather than aggregate identity.

## Test Impact Estimate

- `agents` execution-history/session refactors: medium (contract + store tests + event snapshots).
- `agent-ctrl` aggregated DTO wrappers: low to medium (parser + bridge + event tests).
- Keep-string areas: no migration required, no test churn expected.
