# ID Model Standard

This guide defines when to use typed IDs, and which type of typed ID to use.

## Taxonomy

### 1) Owned IDs

Use for identifiers whose lifecycle is owned by this codebase (entities/aggregates we create and persist).

- Examples: `SessionId`, `MessageId`, `InferenceRequestId`, `StructuredOutputRequestId`
- Implementation:
  - `readonly final class`
  - Thin wrapper over scalar value
  - `generate()` delegates to `Cognesy\Utils\Uuid::uuid4()`
  - Validation delegates to `Cognesy\Utils\Uuid::assertValid()`
  - Must expose `toString()`, `__toString()`, `equals()`

### 2) External IDs (Opaque)

Use for identifiers issued by external systems/providers (we do not generate them and cannot impose UUID format).

- Examples: provider `toolId`, `callId`, `threadId`, provider response item IDs
- Implementation:
  - `readonly final class`
  - No `generate()`
  - No UUID validation
  - Minimal invariant: non-empty string
  - Prefer `fromString(string $value): static` named constructor
  - `__construct(string $value)` validates only local invariants
  - Must expose `toString()`, `__toString()`, `equals()`

### 3) Reference Keys

Keep as strings when the value is a configuration key/label, not a domain identity.

- Examples: service IDs in DI container, config keys, model names
- Do not introduce value objects unless behavior/invariants justify it

## Boundary Rules

- Domain internals: use typed IDs.
- Boundaries only (events, storage payloads, HTTP/CLI DTOs): serialize as strings.
- Hydration/deserialization: reconstruct typed IDs immediately at boundary.
- Events must follow one convention per bounded context:
  - either typed ID properties with boundary conversion in emitters/serializers, or
  - explicit boundary-string IDs with mapper/parser reconstruction into typed IDs.
- Avoid `XxxId|string` in domain/repository/store contracts.

## Decision Matrix

- Generated by us + persisted as identity: `Owned ID` (Uuid-backed).
- Issued externally + identity semantics in domain: `External ID` (opaque wrapper).
- Non-identity key/label: plain `string`.

## Migration Checklist (PR)

- [ ] Classified each touched `*Id` as Owned, External, or Reference Key
- [ ] No `XxxId|string` remains in domain internals
- [ ] Boundary string conversion is explicit and localized
- [ ] Serialization round-trip tests cover typed ID hydration
- [ ] Docs/examples updated for changed public API
